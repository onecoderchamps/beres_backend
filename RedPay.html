<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RedPay Demo - Dynamic Participants Split Layout (Reversed)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Custom style for smoother transitions and shadows */
    .input-field:focus {
      outline: none;
      border-color: #ef4444; /* soft red */
      box-shadow: 0 0 0 1px #ef4444;
    }
    .participant-item {
        transition: all 0.3s ease-in-out;
        transform-origin: top;
    }
    /* Enforce flex basis for the split layout */
    .flex-basis-full { flex-basis: 100%; }
    @media (min-width: 1024px) {
        .lg\:flex-basis-60 { flex-basis: 60%; }
        .lg\:flex-basis-40 { flex-basis: 40%; }
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-6">

<div class="bg-white shadow-xl rounded-xl p-8 w-full max-w-6xl border border-gray-200">
  <h1 class="text-3xl font-extrabold mb-8 text-center text-red-600 border-b pb-3">
    üí≥ RedPay Order Creation: Participant Enrollment
  </h1>

  <form id="orderForm" class="space-y-6">
    
    <div class="lg:flex lg:space-x-8 space-y-6 lg:space-y-0">
      
      <div class="flex-basis-full lg:flex-basis-40 space-y-6">
          
        <div class="space-y-4 p-4 border rounded-lg bg-red-50/50">
          <h2 class="text-xl font-semibold text-gray-700">üè¢ Company Details</h2>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Company Name</label>
            <input name="company" type="text" placeholder="Your Company Name" class="input-field w-full border border-gray-300 rounded-lg px-4 py-2 transition duration-150 ease-in-out" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Business Category</label>
            <input name="category" type="text" placeholder="Example: Tech, Retail, Services" class="input-field w-full border border-gray-300 rounded-lg px-4 py-2 transition duration-150 ease-in-out" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Contact Email</label>
            <input name="email" type="email" placeholder="contact@company.com" class="input-field w-full border border-gray-300 rounded-lg px-4 py-2 transition duration-150 ease-in-out" required>
          </div>
          <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                <input name="phoneNumber" type="tel" placeholder="+62 8xx" class="input-field w-full border border-gray-300 rounded-lg px-4 py-2 transition duration-150 ease-in-out" required>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Website (Optional)</label>
                <input name="website" type="text" placeholder="https://www.site.com" class="input-field w-full border border-gray-300 rounded-lg px-4 py-2 transition duration-150 ease-in-out">
              </div>
          </div>
        </div>
        
        <div class="space-y-3 p-4 border rounded-lg bg-gray-100">
            <h2 class="text-xl font-semibold text-gray-700">üí∞ Payment Method</h2>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Select Payment Method</label>
                <select id="paymentMethod" name="paymentMethod" class="input-field w-full border border-gray-300 rounded-lg px-4 py-2 appearance-none bg-white transition duration-150 ease-in-out" required>
                    <option value="" disabled selected>-- Select Method --</option>
                    <option value="visa_master">üí≥ Credit Card (Visa / MasterCard)</option>
                    <option value="va">üè¶ Virtual Account (VA)</option>
                </select>
            </div>

            <div id="bankOptions" class="hidden">
                <label class="block text-sm font-medium text-gray-700 mb-2">Select VA Bank</label>
                <select id="vaBank" class="input-field w-full border border-gray-300 rounded-lg px-4 py-2 appearance-none bg-white transition duration-150 ease-in-out">
                    <option value="" disabled selected>-- Select VA Bank --</option>
                    <option value="va_bca">BCA</option>
                    <option value="va_bri">BRI</option>
                </select>
            </div>
        </div>
        
      </div>

      <div class="flex-basis-full lg:flex-basis-60 space-y-4 p-4 border rounded-xl bg-gray-50 shadow-inner">
        <h2 class="text-2xl font-bold text-red-600 mb-4 flex items-center">
            üë• Participant
        </h2>
        
        <div id="participantsContainer" class="space-y-4"></div>
        
        <button type="button" id="addParticipant" class="flex items-center space-x-2 mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
          </svg>
          <span>Add New Participant</span>
        </button>
      </div>
      
    </div> <button type="submit" id="submitButton" class="bg-red-600 text-white px-5 py-3 rounded-lg hover:bg-red-700 w-full mt-8 text-lg font-semibold shadow-md transition duration-200 transform hover:scale-[1.005]">
      üöÄ Create Transaction
    </button>
  </form>

  <div id="result" class="mt-8 text-center min-h-[50px]">
    <p class="text-gray-500 italic">Form is ready to be filled.</p>
  </div>
</div>

<script>
  const paymentMethodSelect = document.getElementById("paymentMethod");
  const bankOptions = document.getElementById("bankOptions");
  const participantsContainer = document.getElementById("participantsContainer"); // Renamed
  const resultDiv = document.getElementById("result");
  const submitButton = document.getElementById("submitButton");

  // Toggle bank options visibility
  paymentMethodSelect.addEventListener("change", () => {
    bankOptions.classList.toggle("hidden", paymentMethodSelect.value !== "va");
  });

  // Function to add a new participant field group
  function addParticipant(id = Date.now(), animate = true) {
    const div = document.createElement("div");
    div.classList.add("participant-item", "border", "p-4", "rounded-lg", "relative", "bg-white", "shadow-sm", "space-y-2");
    div.dataset.participantId = id; // Renamed dataset
    
    // Initial scale down for animation
    if (animate) {
        div.style.maxHeight = '0px';
        div.style.opacity = '0';
        div.style.overflow = 'hidden';
    }

    div.innerHTML = `
      <button type="button" class="absolute top-2 right-2 text-red-500 hover:text-red-700 text-2xl font-bold transition duration-200" onclick="removeParticipant(${id})">&times;</button>
      <h3 class="font-semibold text-gray-700">Participant #${participantsContainer.children.length + 1}</h3>
      <div class="grid md:grid-cols-2 gap-3">
        <input name="fullName_${id}" placeholder="Full Name" class="input-field border rounded-lg px-3 py-2" required>
        <input name="position_${id}" placeholder="Position / Title (Optional)" class="input-field border rounded-lg px-3 py-2">
      </div>
      <input name="email_${id}" placeholder="Participant Email" type="email" class="input-field w-full border rounded-lg px-3 py-2" required>
      <input name="phoneNumber_${id}" placeholder="Participant Phone Number" type="tel" class="input-field w-full border rounded-lg px-3 py-2" required>
    `;
    
    participantsContainer.appendChild(div);

    // Animate in
    if (animate) {
        requestAnimationFrame(() => {
            div.style.maxHeight = div.scrollHeight + 'px';
            div.style.opacity = '1';
            setTimeout(() => {
                div.style.maxHeight = ''; // Remove fixed height for content resizing
                div.style.overflow = '';
                updateParticipantNumbers();
            }, 300); // Match transition duration
        });
    } else {
        updateParticipantNumbers();
    }
  }

  // Function to remove a participant field group
  function removeParticipant(id) {
    const div = participantsContainer.querySelector(`[data-participant-id='${id}']`); // Renamed dataset
    if (div) {
        div.style.maxHeight = div.scrollHeight + 'px'; // Set current height
        div.style.opacity = '1';

        // Animate out
        requestAnimationFrame(() => {
            div.style.maxHeight = '0px';
            div.style.opacity = '0';
            div.style.paddingTop = '0';
            div.style.paddingBottom = '0';
            div.style.marginTop = '0';
            div.style.marginBottom = '0';
            setTimeout(() => {
                div.remove();
                if (participantsContainer.children.length === 0) {
                    addParticipant(); // Ensure at least one participant exists
                } else {
                    updateParticipantNumbers();
                }
            }, 300); // Match transition duration
        });
    }
  }

  // Function to update the # numbering when participants are added/removed
  function updateParticipantNumbers() {
      participantsContainer.querySelectorAll('.participant-item').forEach((item, index) => {
          const title = item.querySelector('h3');
          if (title) {
              title.textContent = `Participant #${index + 1}`;
          }
      });
  }

  // Initial setup
  document.getElementById("addParticipant").addEventListener("click", () => addParticipant(Date.now(), true));
  addParticipant(Date.now(), false); // default one participant, no animation on load

  // Handle form submission
  document.getElementById("orderForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    submitButton.disabled = true;
    submitButton.innerHTML = `‚è≥ Processing...`;
    
    // Clear previous result and show loading
    resultDiv.innerHTML = `<div class="p-4 bg-yellow-100 border border-yellow-300 rounded-lg text-yellow-800 flex items-center justify-center space-x-2">
                            <svg class="animate-spin h-5 w-5 text-yellow-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span>Sending transaction data...</span>
                           </div>`;

    const form = e.target;
    let paymentMethod = paymentMethodSelect.value;
    if (paymentMethod === "va") {
      const vaBank = document.getElementById("vaBank").value;
      if (!vaBank) {
        alert("Please select a bank for the Virtual Account!");
        submitButton.disabled = false;
        submitButton.innerHTML = `üöÄ Create Transaction`;
        resultDiv.innerHTML = `<p class="text-red-600">‚ö†Ô∏è Please select a bank for the Virtual Account!</p>`;
        return;
      }
      paymentMethod = vaBank;
    }

    // Build body
    const body = {
      company: form.company.value,
      category: form.category.value,
      website: form.website.value,
      phoneNumber: form.phoneNumber.value,
      email: form.email.value,
      paymentMethod,
      memberOrder: [] // API still uses 'memberOrder', we map our data to it
    };

    // Collect participant data
    participantsContainer.querySelectorAll("div[data-participant-id]").forEach(div => {
      const id = div.dataset.participantId;
      const participant = {
        idUser: "DYNAMIC_ID_" + id, 
        fullName: div.querySelector(`input[name='fullName_${id}']`).value,
        position: div.querySelector(`input[name='position_${id}']`).value,
        email: div.querySelector(`input[name='email_${id}']`).value,
        phoneNumber: div.querySelector(`input[name='phoneNumber_${id}']`).value
      };
      body.memberOrder.push(participant);
    });

    try {
      const res = await fetch("https://apiberes.coderchamps.co.id/api/v1/RedPay/createOrder", {
        method: "POST",
        headers: { "Content-Type": "application/json", "Accept": "*/*" },
        body: JSON.stringify(body)
      });

      const data = await res.json();
      console.log(data);

      if (res.ok && data.paymentUrl) {
        if (paymentMethod.startsWith("va_")) {
          // Display VA Number
          resultDiv.innerHTML = `<div class="p-6 bg-green-100 border-2 border-green-500 rounded-lg text-left shadow-lg">
                                  <p class="text-lg font-semibold text-green-700">‚úÖ Transaction Created Successfully!</p>
                                  <p class="text-sm text-gray-600 mt-1">Use the Virtual Account number below to complete the payment:</p>
                                  <div class="mt-3 bg-white p-3 border border-dashed border-green-400 rounded-md">
                                    <p class="text-sm font-medium text-gray-700">Virtual Account Number (${paymentMethod.toUpperCase().replace('VA_', '')}):</p>
                                    <p class="text-3xl font-extrabold text-green-600 tracking-wider break-all">${data.paymentUrl || "VA Number not available"}</p>
                                  </div>
                                </div>`;
        } else {
          // Redirect for CC/Other methods
          window.open(data.paymentUrl, "_blank");
          resultDiv.innerHTML = `<div class="p-4 bg-blue-100 border border-blue-400 rounded-lg text-blue-800">
                                  <p class="font-semibold">Redirecting...</p>
                                  <p>You are being redirected to the payment page. Please check your new window/tab.</p>
                                </div>`;
        }
      } else {
        // Handle API error/non-paymentUrl response
        const errorMessage = data.message || `Code: ${data.code || 'N/A'}`;
        resultDiv.innerHTML = `<div class="p-4 bg-red-100 border border-red-400 rounded-lg text-red-800">
                                <p class="font-semibold">‚ùå Failed to Create Transaction!</p>
                                <p>Detail: ${errorMessage}</p>
                              </div>`;
      }

    } catch (err) {
      console.error(err);
      resultDiv.innerHTML = `<div class="p-4 bg-red-100 border border-red-400 rounded-lg text-red-800">
                              <p class="font-semibold">üî• Network/System Error Occurred!</p>
                              <p>Please try again or contact the administrator. (${err.message})</p>
                            </div>`;
    } finally {
      submitButton.disabled = false;
      submitButton.innerHTML = `üöÄ Create Transaction`;
    }
  });
</script>

</body>
</html>